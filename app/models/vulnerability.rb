class Vulnerability < ApplicationRecord
  belongs_to :gem_version, counter_cache: true
  has_many :resources, through: :gem_version
  has_one :gem_info, through: :gem_version

  validates :description, presence: true

  after_create  { update_vulnerabilities_counts! }
  after_destroy { update_vulnerabilities_counts! }

  private

  def update_vulnerabilities_counts!
    self.class.uncached { resources.reload }.each &:update_vulnerabilities_count!
  end
end
